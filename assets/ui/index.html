<!-- Pregame City UI - Hytopia Compatible -->
<!-- NOTE: No <html>, <head>, or <body> tags per Hytopia SDK requirements -->

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    background: transparent;
  }

  #hud-root {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
  }

  /* HUD Styles */
  .hud-root-inner {
    width: 100%;
    height: 100%;
    position: relative;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .hud-top-banner {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.85), rgba(20, 20, 40, 0.85));
    padding: 12px 30px;
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }

  .hud-banner-main {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 18px;
    font-weight: bold;
  }

  .hud-banner-icon {
    font-size: 24px;
  }

  .hud-banner-timer {
    color: #FFD700;
    font-size: 20px;
    font-family: 'Courier New', monospace;
  }

  .hud-top-right-wrapper {
    position: absolute;
    top: 20px;
    right: 20px;
  }

  .hud-mini-scores {
    background: rgba(0, 0, 0, 0.8);
    padding: 15px 25px;
    border-radius: 8px;
    border: 2px solid rgba(255, 215, 0, 0.5);
  }

  .hud-mini-score-row {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    font-size: 20px;
  }

  .hud-mini-score-value {
    color: #FFD700;
    font-weight: bold;
    font-size: 24px;
  }

  .hud-bottom-left-wrapper {
    position: absolute;
    bottom: 20px;
    left: 20px;
  }

  .hud-player-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(30, 30, 60, 0.9));
    padding: 15px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    min-width: 200px;
  }

  .hud-player-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .hud-avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .hud-player-name {
    font-size: 16px;
    font-weight: bold;
  }

  .hud-player-rank {
    font-size: 12px;
    color: #FFD700;
    text-transform: uppercase;
  }

  .hud-xp-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
  }

  .hud-xp-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
  }

  .hud-player-meta {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #CCC;
  }

  .hud-bottom-center-wrapper {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
  }

  .hud-actions-bar {
    background: rgba(0, 0, 0, 0.85);
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }

  .hud-action-key {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: bold;
    color: #FFD700;
  }

  .hud-action-divider {
    color: rgba(255, 255, 255, 0.4);
  }

  .hud-bottom-right-wrapper {
    position: absolute;
    bottom: 20px;
    right: 20px;
  }

  .hud-emote-chat {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 13px;
  }

  .hud-emote-btn, .hud-chat-btn {
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 15px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    text-align: center;
  }

  /* Notification Toasts */
  #notification-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 200;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 350px;
  }

  .notification-toast {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(30, 30, 60, 0.95));
    padding: 15px 20px;
    border-radius: 8px;
    border-left: 4px solid #FFD700;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 14px;
    animation: slideIn 0.3s ease-out, slideOut 0.3s ease-out 2.7s;
    opacity: 1;
  }

  .notification-toast.xp {
    border-left-color: #4CAF50;
  }

  .notification-toast.coins {
    border-left-color: #FFD700;
  }

  .notification-toast.info {
    border-left-color: #2196F3;
  }

  .notification-toast.warning {
    border-left-color: #FF9800;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }

  /* Emote Wheel */
  #emote-wheel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
    pointer-events: auto;
  }

  #emote-wheel-overlay.active {
    display: flex;
  }

  .emote-wheel {
    position: relative;
    width: 300px;
    height: 300px;
  }

  .emote-item {
    position: absolute;
    width: 80px;
    height: 80px;
    background: rgba(0, 0, 0, 0.9);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .emote-item:hover {
    background: rgba(50, 50, 100, 0.9);
    border-color: #FFD700;
    transform: scale(1.1);
  }

  .emote-label {
    font-size: 10px;
    color: white;
    margin-top: 4px;
  }

  /* Quick Chat */
  #quick-chat-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
    pointer-events: auto;
  }

  #quick-chat-overlay.active {
    display: flex;
  }

  .quick-chat-menu {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(30, 30, 60, 0.95));
    padding: 20px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    min-width: 300px;
  }

  .quick-chat-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-align: center;
  }

  .quick-chat-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: white;
    font-size: 14px;
  }

  .quick-chat-item:hover {
    background: rgba(255, 215, 0, 0.2);
    transform: translateX(5px);
  }

  /* Scoreboard */
  #scoreboard-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
    pointer-events: auto;
  }

  #scoreboard-overlay.active {
    display: flex;
  }

  .scoreboard-panel {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(30, 30, 60, 0.95));
    padding: 30px;
    border-radius: 12px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    min-width: 500px;
    max-width: 700px;
  }

  .scoreboard-title {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #FFD700;
    text-align: center;
    text-transform: uppercase;
  }

  .scoreboard-table {
    width: 100%;
    border-collapse: collapse;
  }

  .scoreboard-table th {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px;
    text-align: left;
    color: #FFD700;
    font-size: 14px;
    text-transform: uppercase;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  }

  .scoreboard-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
  }

  .scoreboard-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .scoreboard-close-hint {
    text-align: center;
    margin-top: 20px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
  }

  /* Shot Power/Aim Meter */
  #shot-meter {
    position: fixed;
    bottom: 150px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 20px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: none;
    flex-direction: column;
    gap: 10px;
    min-width: 300px;
    pointer-events: none;
  }

  #shot-meter.active {
    display: flex;
  }

  .meter-label {
    font-size: 14px;
    color: #FFD700;
    font-weight: bold;
    text-align: center;
  }

  .meter-bar-container {
    width: 100%;
    height: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .meter-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #FF5252, #FFD700, #4CAF50);
    transition: width 0.05s linear;
  }

  .meter-target-zone {
    position: absolute;
    top: 0;
    height: 100%;
    background: rgba(76, 175, 80, 0.3);
    border: 2px solid #4CAF50;
  }
</style>

<!-- HUD Container -->
<div id="hud-root"></div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Emote Wheel Overlay -->
<div id="emote-wheel-overlay">
  <div class="emote-wheel" id="emote-wheel"></div>
</div>

<!-- Quick Chat Overlay -->
<div id="quick-chat-overlay">
  <div class="quick-chat-menu" id="quick-chat-menu">
    <div class="quick-chat-title">Quick Chat</div>
    <div class="quick-chat-items" id="quick-chat-items"></div>
  </div>
</div>

<!-- Scoreboard Overlay -->
<div id="scoreboard-overlay">
  <div class="scoreboard-panel">
    <div class="scoreboard-title">Scoreboard</div>
    <table class="scoreboard-table" id="scoreboard-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Player</th>
          <th>Score</th>
          <th>XP</th>
        </tr>
      </thead>
      <tbody id="scoreboard-body">
        <tr>
          <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.5);">
            No data available yet
          </td>
        </tr>
      </tbody>
    </table>
    <div class="scoreboard-close-hint">Press Tab to close</div>
  </div>
</div>

<!-- Shot Meter -->
<div id="shot-meter">
  <div class="meter-label">SHOT POWER</div>
  <div class="meter-bar-container">
    <div class="meter-target-zone" id="power-target" style="left: 70%; width: 20%;"></div>
    <div class="meter-bar-fill" id="power-fill" style="width: 0%;"></div>
  </div>
  <div class="meter-label">AIM</div>
  <div class="meter-bar-container">
    <div class="meter-target-zone" id="aim-target" style="left: 45%; width: 10%;"></div>
    <div class="meter-bar-fill" id="aim-fill" style="width: 0%;"></div>
  </div>
  <div style="text-align: center; color: #FFD700; font-size: 12px; margin-top: 5px;">
    Press SPACE to shoot
  </div>
</div>

<script>
  // ============================================================================
  // Pregame City Client UI - Hytopia Native API
  // ============================================================================

  // State Management
  const state = {
    zoneId: null,
    inChallenge: false,
    sport: null,
    challengeSessionId: null,
    challengeName: null,
    timeRemaining: null,
    rank: "rookie",
    xp: 0,
    coins: 0,
    score: 0,
    nearbyField: null,
    shotMeterActive: false,
    powerValue: 0,
    aimValue: 0,
    powerDirection: 1,
    aimDirection: 1
  };

  // DOM Elements
  const hudRoot = document.getElementById('hud-root');
  const notificationContainer = document.getElementById('notification-container');
  const emoteWheelOverlay = document.getElementById('emote-wheel-overlay');
  const emoteWheel = document.getElementById('emote-wheel');
  const quickChatOverlay = document.getElementById('quick-chat-overlay');
  const quickChatItems = document.getElementById('quick-chat-items');
  const scoreboardOverlay = document.getElementById('scoreboard-overlay');
  const shotMeter = document.getElementById('shot-meter');
  const powerFill = document.getElementById('power-fill');
  const aimFill = document.getElementById('aim-fill');

  // ============================================================================
  // HUD Rendering
  // ============================================================================

  function getSportIcon(sport) {
    const icons = {
      basketball: "üèÄ",
      football: "üèà",
      soccer: "‚öΩ",
      baseball: "‚öæ",
      tennis: "üéæ"
    };
    return icons[sport] || "‚≠ê";
  }

  function formatTime(seconds) {
    if (seconds == null) return "--:--";
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return `${String(m).padStart(2, "0")}:${String(r).padStart(2, "0")}`;
  }

  function renderHUD() {
    const s = state;

    const banner = s.inChallenge
      ? `
      <div class="hud-banner-main">
        <span class="hud-banner-icon">${getSportIcon(s.sport)}</span>
        <span class="hud-banner-title">${(s.sport || "").toUpperCase()} ‚Äì Challenge</span>
        <span class="hud-banner-timer">${formatTime(s.timeRemaining)}</span>
        <span class="hud-banner-rank">Rank: ${s.rank.toUpperCase()}</span>
      </div>`
      : `
      <div class="hud-banner-main">
        <span class="hud-banner-icon">üèôÔ∏è</span>
        <span class="hud-banner-title">Pregame City ‚Äì Free Roam</span>
        <span class="hud-banner-zone">${s.zoneId ? `Zone: ${s.zoneId}` : ""}</span>
        <span class="hud-banner-rank">Rank: ${s.rank.toUpperCase()}</span>
      </div>`;

    const topBanner = `<div class="hud-top-banner">${banner}</div>`;

    const scorePanel = s.inChallenge
      ? `<div class="hud-mini-scores">
          <div class="hud-mini-score-row">
            <span class="hud-mini-score-name">Score</span>
            <span class="hud-mini-score-value">${s.score}</span>
          </div>
        </div>`
      : "";

    const playerCard = `
      <div class="hud-player-card">
        <div class="hud-player-header">
          <div class="hud-avatar-circle">üèÖ</div>
          <div class="hud-player-text">
            <div class="hud-player-name">You</div>
            <div class="hud-player-rank">${s.rank.toUpperCase()}</div>
          </div>
        </div>
        <div class="hud-xp-bar">
          <div class="hud-xp-fill" style="width: ${Math.min(100, (s.xp % 1000) / 10)}%;"></div>
        </div>
        <div class="hud-player-meta">
          <span>XP: ${s.xp}</span>
          <span>Coins: ${s.coins}</span>
        </div>
      </div>
    `;

    const actionsBar = `
      <div class="hud-actions-bar">
        <span class="hud-action-key">E</span> <span class="hud-action-text">Interact / Start Challenge</span>
        <span class="hud-action-divider">|</span>
        <span class="hud-action-key">Tab</span> <span class="hud-action-text">Scoreboard</span>
        <span class="hud-action-divider">|</span>
        <span class="hud-action-key">G</span> <span class="hud-action-text">Emote Wheel</span>
        <span class="hud-action-divider">|</span>
        <span class="hud-action-key">C</span> <span class="hud-action-text">Quick Chat</span>
      </div>
    `;

    const emoteChat = `
      <div class="hud-emote-chat">
        <div class="hud-emote-btn">G ‚Äì Emotes</div>
        <div class="hud-chat-btn">C ‚Äì Quick Chat</div>
      </div>
    `;

    hudRoot.innerHTML = `
      <div class="hud-root-inner">
        ${topBanner}
        <div class="hud-top-right-wrapper">
          ${scorePanel}
        </div>
        <div class="hud-bottom-left-wrapper">
          ${playerCard}
        </div>
        <div class="hud-bottom-center-wrapper">
          ${actionsBar}
        </div>
        <div class="hud-bottom-right-wrapper">
          ${emoteChat}
        </div>
      </div>
    `;
  }

  // ============================================================================
  // Notification System
  // ============================================================================

  function showNotification(message, category = 'info') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${category}`;
    toast.textContent = message;

    notificationContainer.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // ============================================================================
  // Emote Wheel
  // ============================================================================

  const emotes = [
    { id: 'wave', icon: 'üëã', label: 'Wave' },
    { id: 'thumbsup', icon: 'üëç', label: 'Nice' },
    { id: 'clap', icon: 'üëè', label: 'Clap' },
    { id: 'fire', icon: 'üî•', label: 'Fire' },
    { id: 'heart', icon: '‚ù§Ô∏è', label: 'Love' },
    { id: 'laugh', icon: 'üòÇ', label: 'LOL' },
    { id: 'flex', icon: 'üí™', label: 'Flex' },
    { id: 'thinking', icon: 'ü§î', label: 'Think' }
  ];

  function initEmoteWheel() {
    const radius = 120;
    const centerX = 150;
    const centerY = 150;

    emotes.forEach((emote, index) => {
      const angle = (index / emotes.length) * 2 * Math.PI - Math.PI / 2;
      const x = centerX + radius * Math.cos(angle) - 40;
      const y = centerY + radius * Math.sin(angle) - 40;

      const emoteEl = document.createElement('div');
      emoteEl.className = 'emote-item';
      emoteEl.style.left = `${x}px`;
      emoteEl.style.top = `${y}px`;
      emoteEl.innerHTML = `${emote.icon}<div class="emote-label">${emote.label}</div>`;
      emoteEl.onclick = () => selectEmote(emote.id);

      emoteWheel.appendChild(emoteEl);
    });
  }

  function selectEmote(emoteId) {
    console.log('Emote selected:', emoteId);
    hytopia.sendData({
      type: 'uiEmote',
      emoteId: emoteId
    });
    hideEmoteWheel();
  }

  function showEmoteWheel() {
    emoteWheelOverlay.classList.add('active');
  }

  function hideEmoteWheel() {
    emoteWheelOverlay.classList.remove('active');
  }

  // ============================================================================
  // Quick Chat
  // ============================================================================

  const quickChatMessages = [
    { id: 'gg', text: 'Good game!' },
    { id: 'nice', text: 'Nice shot!' },
    { id: 'thanks', text: 'Thanks!' },
    { id: 'sorry', text: 'Sorry!' },
    { id: 'challenge', text: "Let's challenge!" },
    { id: 'again', text: 'One more time!' }
  ];

  function initQuickChat() {
    quickChatItems.innerHTML = '';
    quickChatMessages.forEach(msg => {
      const item = document.createElement('div');
      item.className = 'quick-chat-item';
      item.textContent = msg.text;
      item.onclick = () => selectQuickChat(msg.id, msg.text);
      quickChatItems.appendChild(item);
    });
  }

  function selectQuickChat(msgId, text) {
    console.log('Quick chat selected:', msgId);
    hytopia.sendData({
      type: 'uiQuickChat',
      messageId: msgId,
      message: text
    });
    hideQuickChat();
  }

  function showQuickChat() {
    quickChatOverlay.classList.add('active');
  }

  function hideQuickChat() {
    quickChatOverlay.classList.remove('active');
  }

  // ============================================================================
  // Scoreboard
  // ============================================================================

  function showScoreboard() {
    scoreboardOverlay.classList.add('active');
  }

  function hideScoreboard() {
    scoreboardOverlay.classList.remove('active');
  }

  // ============================================================================
  // Shot Meter
  // ============================================================================

  let shotMeterInterval = null;

  function startShotMeter() {
    state.shotMeterActive = true;
    state.powerValue = 0;
    state.aimValue = 0;
    state.powerDirection = 1;
    state.aimDirection = 1;

    shotMeter.classList.add('active');

    shotMeterInterval = setInterval(() => {
      // Power meter oscillates
      state.powerValue += state.powerDirection * 2;
      if (state.powerValue >= 100) {
        state.powerValue = 100;
        state.powerDirection = -1;
      } else if (state.powerValue <= 0) {
        state.powerValue = 0;
        state.powerDirection = 1;
      }

      // Aim meter oscillates
      state.aimValue += state.aimDirection * 3;
      if (state.aimValue >= 100) {
        state.aimValue = 100;
        state.aimDirection = -1;
      } else if (state.aimValue <= 0) {
        state.aimValue = 0;
        state.aimDirection = 1;
      }

      powerFill.style.width = `${state.powerValue}%`;
      aimFill.style.width = `${state.aimValue}%`;
    }, 50);
  }

  function stopShotMeter() {
    state.shotMeterActive = false;
    shotMeter.classList.remove('active');
    if (shotMeterInterval) {
      clearInterval(shotMeterInterval);
      shotMeterInterval = null;
    }
  }

  function captureShot() {
    if (!state.shotMeterActive || !state.challengeSessionId) return;

    const powerNormalized = state.powerValue / 100;
    const aimNormalized = state.aimValue / 100;

    // Calculate timing (how close to green zone 70-90%)
    const timing = 1 - Math.abs(powerNormalized - 0.8) / 0.8;

    // Calculate aim offset (how close to center 45-55%)
    const aimOffset = Math.abs(aimNormalized - 0.5) * 2;

    console.log('Shot captured:', { timing, aimOffset });

    hytopia.sendData({
      type: 'basketballShotAttempt',
      challengeSessionId: state.challengeSessionId,
      shotType: 'midrange', // TODO: detect based on player position
      timing: timing,
      aimOffset: aimOffset,
      contested: false
    });

    stopShotMeter();
  }

  // ============================================================================
  // Input Handling
  // ============================================================================

  document.addEventListener('keydown', (e) => {
    // Ignore if typing in input fields
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    switch(e.key.toLowerCase()) {
      case 'e':
        if (state.nearbyField && !state.inChallenge) {
          const challengeId = state.nearbyField.sport === 'basketball'
            ? 'basketball_shooting_60s'
            : state.nearbyField.sport + '_challenge';

          hytopia.sendData({
            type: 'uiRequestStartChallenge',
            sport: state.nearbyField.sport,
            challengeId: challengeId,
            fieldId: state.nearbyField.fieldId
          });
        }
        break;

      case 'g':
        if (!state.inChallenge) {
          showEmoteWheel();
        }
        break;

      case 'c':
        if (!state.inChallenge) {
          showQuickChat();
        }
        break;

      case 'tab':
        e.preventDefault();
        if (scoreboardOverlay.classList.contains('active')) {
          hideScoreboard();
        } else {
          showScoreboard();
        }
        break;

      case ' ':
        if (state.inChallenge && state.sport === 'basketball') {
          if (state.shotMeterActive) {
            captureShot();
          } else {
            startShotMeter();
          }
        }
        break;

      case 'escape':
        hideEmoteWheel();
        hideQuickChat();
        hideScoreboard();
        break;
    }
  });

  // Close overlays on click outside
  emoteWheelOverlay.addEventListener('click', (e) => {
    if (e.target === emoteWheelOverlay) {
      hideEmoteWheel();
    }
  });

  quickChatOverlay.addEventListener('click', (e) => {
    if (e.target === quickChatOverlay) {
      hideQuickChat();
    }
  });

  scoreboardOverlay.addEventListener('click', (e) => {
    if (e.target === scoreboardOverlay) {
      hideScoreboard();
    }
  });

  // ============================================================================
  // Server Message Handling (Hytopia Native API)
  // ============================================================================

  hytopia.onData((data) => {
    if (!data || !data.type) return;

    console.log('Received:', data.type, data);

    switch (data.type) {
      case 'zoneChanged':
        state.zoneId = data.zoneId;
        renderHUD();
        break;

      case 'challengeStarted':
        state.inChallenge = true;
        state.sport = data.sport;
        state.challengeSessionId = data.challengeSessionId;
        state.challengeName = data.challengeId;
        state.timeRemaining = data.durationSeconds;
        state.score = 0;
        renderHUD();
        showNotification(`${data.sport.toUpperCase()} Challenge Started!`, 'info');
        break;

      case 'challengeScoreUpdated':
        state.score = data.score;
        state.timeRemaining = data.timeRemaining;
        renderHUD();
        break;

      case 'challengeEnded':
        state.inChallenge = false;
        state.challengeSessionId = null;
        state.timeRemaining = null;
        state.challengeName = null;
        stopShotMeter();
        renderHUD();
        showNotification(`Challenge Complete! +${data.xpEarned} XP, +${data.coinsEarned} Coins`, 'xp');
        break;

      case 'xpUpdated':
        state.xp = data.xp;
        state.rank = data.rank;
        renderHUD();
        break;

      case 'coinsUpdated':
        state.coins = data.coins;
        renderHUD();
        break;

      case 'notification':
        showNotification(data.message, data.category || 'info');
        break;

      case 'enteredSportsFieldTrigger':
        state.nearbyField = {
          fieldId: data.fieldId,
          sport: data.sport,
          mode: data.mode
        };
        showNotification(`Press E to start ${data.sport} challenge`, 'info');
        break;

      case 'exitedSportsFieldTrigger':
        state.nearbyField = null;
        break;

      case 'basketballShotResult':
        if (data.made) {
          showNotification(`+${data.points} points! ${data.reason}`, 'xp');
        } else {
          showNotification(`Miss! ${data.reason}`, 'warning');
        }
        break;

      default:
        console.log('Unknown message type:', data.type);
    }
  });

  // ============================================================================
  // Initialization
  // ============================================================================

  console.log('üéÆ Pregame City UI Initialized (Hytopia Native)');
  initEmoteWheel();
  initQuickChat();
  renderHUD();
</script>
